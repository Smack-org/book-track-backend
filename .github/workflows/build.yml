name: Book Track Build

on:
  workflow_dispatch:
  pull_request:
    paths:
      - .github/workflows/build.yml
      - src/**
      - tests/**
      - Dockerfile

jobs:
  lint-test:
    runs-on: ubuntu-latest
    name: Lint and Test
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            "fastapi>=0.115.2,<0.116.0" \
            "uvicorn>=0.34.2,<0.35.0" \
            "fastapi-code-generator>=0.5.3,<0.6.0" \
            "python-dotenv>=0.9.9,<0.10.0" \
            "prometheus-fastapi-instrumentator>=7.1.0,<8.0.0" \
            "sqlalchemy>=2.0.40,<3.0.0" \
            "python-jose>=3.4.0,<4.0.0" \
            "passlib>=1.7.4,<2.0.0" \
            "asyncpg>=0.30.0,<0.31.0" \
            "python-multipart>=0.0.20,<0.0.21" \
            "databases>=0.9.0,<0.10.0" \
            "coverage>=7.8.0,<8.0.0" \
            "gevent>=25.4.2,<26.0.0" \
            "h11>=0.16.0,<0.17.0" \
            "async-lru>=2.0.5,<3.0.0" \
            pytest pytest-cov

      - name: Run Radon Maintainability Check
        run: |
          output=$(radon mi -s . -e tests/conftest.py)
          echo "$output"
          error_found=0
          while IFS= read -r line; do
            metric=$(echo "$line" | grep -oP '\(\K[0-9.]+(?=\))')
            if [ ! -z "$metric" ]; then
              if (( $(echo "$metric < 70" | bc -l) )); then
                echo "Fail: '$line' has a maintainability metric below 70."
                error_found=1
              fi
            fi
          done <<< "$output"

          if [ $error_found -ne 0 ]; then
            echo "One or more files have a maintainability metric below 70. Failing the build."
            exit 1
          else
            echo "All files have acceptable maintainability metrics."
          fi
        shell: bash

      - name: Run Flake8 Linting
        run: flake8 .

      - name: Run unit tests
        shell: bash
        run: |
          set -ex

          testlog=unit-tests-report.txt

          # Run tests and store the output in a log file
          pytest --cov=src ./unit-tests -p no:warnings > $testlog

          # Check if there are any test failures
          if grep -q "FAILED" $testlog; then
              echo "Some of the tests have failed! Heads up!"
              exit 1
          fi

          echo "===== COVERAGE ====="

          # Extract the coverage percentage from the "TOTAL" line
          coverage=$(grep -oP 'TOTAL\s+\d+\s+\d+\s+\K\d+' $testlog)

          # Print the extracted coverage percentage
          echo "Total coverage: ${coverage:-Unavailable}%"

          # Check if the coverage is less than 65%
          echo "If smaller than 65% - too bad."
          if [ -n "$coverage" ] && [ "$(echo "$coverage < 65" | bc)" -eq 1 ]; then
              echo "Coverage $coverage% is too low!"
              exit 1
          fi

          echo "Wow! Coverage is higher than 65%, congrats!"

      - name: Is there docker compose ?
        run: |
          docker compose version || docker-compose version

      - name: Run e2e tests
        run: |
          docker compose --file compose.test.yaml up --build -d &> /dev/null

          echo "Tests are granted 15 seconds to run"
          sleep 15

          echo "Time is up! Stopping the containers..."
          docker compose --file compose.test.yaml down &> /dev/null

          echo "===== TEST LOGS ====="
          cat /tmp/booktrack/testlog.txt || echo "No test log found."

          if grep -q "FAILED" /tmp/booktrack/testlog.txt; then
            echo "Some of the tests have failed! Heads up!"
            exit 1
          fi

          echo "===== COVERAGE ====="
          coverage=$(tail -1 /tmp/booktrack/report.txt 2>/dev/null | awk '{print $NF}' | tr -d '%')
          echo "Total coverage: ${coverage:-Unavailable}%"

          echo "If smaller than 65% - too bad."
          if [ -n "$coverage" ] && [ "$(echo "$coverage < 65" | bc)" -eq 1 ]; then
            echo "Coverage $coverage% is too low!"
            exit 1
          fi

          echo "Wow! Coverage is higher than 65%, congrats !"
